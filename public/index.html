<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alif Payment </title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#fff;}
.center-box{max-width:400px;margin:50px auto;padding:20px;border-radius:15px;background:#1e293b;text-align:center;}
.btn{width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;background:#3b82f6;color:#fff;font-weight:bold;font-size:16px;}
.btn:hover{background:#1d4ed8;}
.input{width:100%;padding:10px;margin:6px 0;border-radius:10px;border:none;background:#334155;color:#fff;}
.dashboard{max-width:480px;margin:20px auto;padding:20px;border-radius:15px;background:#1e293b;display:none;}
.balance-box{background:#3b82f6;padding:12px;border-radius:10px;margin:12px 0;font-weight:bold;text-align:center;}
.block{background:#0f172a;padding:10px;margin:8px 0;border-radius:10px;border-left:4px solid #3b82f6;font-size:12px;}
</style>
</head>
<body>

<div id="welcome" class="center-box">
<h2>Alif Payment v3</h2>
<button class="btn" onclick="createWallet()">Create New Wallet</button>
<input id="importKey" class="input" placeholder="Enter Private Key">
<button class="btn" onclick="importWallet()">Import Wallet</button>
</div>

<div id="pinScreen" class="center-box" style="display:none;">
<h2>Enter PIN</h2>
<input id="pinInput" class="input" type="password" maxlength="6" placeholder="PIN">
<button class="btn" onclick="unlockWallet()">Unlock</button>
</div>

<div id="dashboard" class="dashboard">
<button class="btn" style="background:#ef4444;margin-bottom:12px;" onclick="resetWallet()">Reset Wallet</button>
<div id="walletInfo"></div>
<div id="balance" class="balance-box">Balance: 0 DPT</div>
<h3>Send Payment</h3>
<input id="receiver" class="input" placeholder="Receiver Wallet ID">
<input id="amount" class="input" type="number" placeholder="Amount">
<button class="btn" onclick="sendTokens()">Send</button>
<h3>Ledger Blocks</h3>
<div id="chain" style="max-height:300px;overflow-y:auto;"></div>
</div>

<script>
const SERVER_URL='https://alif-b788.onrender.com'; // Your deployed server
let ledger=[], currentWallet=null, ws=null;

// --- Ledger fetch & WebSocket ---
async function fetchLedger(){
    const res=await fetch(`${SERVER_URL}/ledger`);
    ledger=await res.json();
    updateBalance();
    renderChain();
}

function connectWebSocket(){
    if(ws) ws.close();
    ws=new WebSocket(SERVER_URL.replace(/^http/,'ws'));
    ws.onmessage=e=>{
        const data=JSON.parse(e.data);
        if(data.type==='new_block') ledger.push(data.block);
        updateBalance();
        renderChain();
    };
}

// --- Wallet functions ---
function createWallet(){
    const pk='PRIV-'+Math.random().toString(36).substring(2,16);
    const pub='WALLET-'+Math.random().toString(36).substring(2,10);
    const pin=prompt('Create PIN (4-6 digits)');
    if(!pin||pin.length<4) return alert('Invalid PIN');

    currentWallet={privateKey: pk, publicKey: pub};
    localStorage.setItem('wallet_pin', pin);
    sessionStorage.setItem('wallet_pub', pub);

    // Mint 100 tokens from GENESIS_POOL
    sendTransaction('GENESIS_POOL', pub, 100).then(()=>switchToDashboard());
}

function importWallet(){
    const key=document.getElementById('importKey').value.trim();
    if(!key.startsWith('PRIV-')) return alert('Invalid key');
    const pin=prompt('Set PIN (4-6 digits)');
    if(!pin||pin.length<4) return alert('Invalid PIN');

    const pub='WALLET-'+key.slice(5,12);
    currentWallet={privateKey: key, publicKey: pub};
    localStorage.setItem('wallet_pin', pin);
    sessionStorage.setItem('wallet_pub', pub);

    // Mint if first time
    sendTransaction('GENESIS_POOL', pub, 100).then(()=>switchToDashboard());
}

function unlockWallet(){
    const savedPin = localStorage.getItem('wallet_pin');
    const entered = document.getElementById('pinInput').value;
    if(entered !== savedPin) return alert('Wrong PIN');

    const pub = sessionStorage.getItem('wallet_pub');
    if(!pub) return alert('No wallet found');

    currentWallet = {privateKey: null, publicKey: pub};
    switchToDashboard();
}

function resetWallet(){
    if(!confirm('Reset wallet?')) return;
    localStorage.removeItem('wallet_pin');
    sessionStorage.removeItem('wallet_pub');
    currentWallet=null; ledger=[];
    document.getElementById('dashboard').style.display='none';
    document.getElementById('welcome').style.display='block';
}

// --- Dashboard ---
function switchToDashboard(){
    document.getElementById('welcome').style.display='none';
    document.getElementById('pinScreen').style.display='none';
    document.getElementById('dashboard').style.display='block';
    showWallet();
    fetchLedger();
    connectWebSocket();
}

function showWallet(){
    updateBalance();
    document.getElementById('walletInfo').innerHTML=`<div class="block"><b>Wallet ID:</b> ${currentWallet.publicKey}<br><b>Private Key:</b> ${currentWallet.privateKey ? currentWallet.privateKey : 'Hidden'}</div>`;
}

function updateBalance(){
    if(!currentWallet) return;
    let bal=0;
    ledger.forEach(b=>{
        if(b.to===currentWallet.publicKey) bal+=b.amount;
        if(b.from===currentWallet.publicKey) bal-=b.amount;
    });
    document.getElementById('balance').innerText='Balance: '+bal+' DPT';
}

function renderChain(){
    const div=document.getElementById('chain');
    div.innerHTML='';
    ledger.forEach(b=>{
        div.innerHTML+=`<div class="block">
            <b>Block #${b.index}</b><br>
            From: ${b.from}<br>
            To: ${b.to}<br>
            Amount: ${b.amount}<br>
            PrevHash: ${b.prevHash}<br>
            Hash: ${b.hash}
        </div>`;
    });
}

// --- Send tokens ---
async function sendTransaction(from,to,amount){
    await fetch(`${SERVER_URL}/transaction`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({from,to,amount})
    });
}

async function sendTokens(){
    if(!currentWallet) return alert('Create wallet');
    const to=document.getElementById('receiver').value.trim();
    const amount=Number(document.getElementById('amount').value);
    if(!to.startsWith('WALLET-')) return alert('Invalid receiver');
    if(amount<=0) return alert('Invalid amount');

    await sendTransaction(currentWallet.publicKey,to,amount);
    alert('Sent successfully!');
    fetchLedger();
}

// --- On Load ---
window.onload=function(){
    if(sessionStorage.getItem('wallet_pub')){
        document.getElementById('pinScreen').style.display='block';
    } else {
        document.getElementById('welcome').style.display='block';
    }
};
</script>

</body>
</html>
